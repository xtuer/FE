<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>画图</title>

    <!-- 1. 引入需要的 js 和 css -->
    <script src='http://cdn.bootcss.com/jquery/3.2.1/jquery.min.js'></script>
    <script src="http://cdn.staticfile.org/layer/2.3/layer.js"></script>
    <script src='painter.js'></script>
    <link  href="painter.css" rel="stylesheet">

    <style media="screen">
        body {
            font-family: Arial, Helvetica, sans-serif; /* 字体 */
            font-size: 12px; /* 字体大小12像素 */
        }

        #painter {
            display: none;
            padding: 20px;
        }
    </style>
</head>

<body>
    <button class="question-button" data-question-id="quesiton-1">问题一</button>
    <button class="question-button" data-question-id="quesiton-2">问题二</button>
    <button class="question-button" data-question-id="quesiton-3">问题三</button>

    <!-- 2. 定义画图板的 html -->
    <div id="painter">
        <!-- 绘图的工具栏 -->
        <div class="toolbar">
            <img src="img/move.png"     data-type="move"  title="移动">
            <img src="img/curve.png"    data-type="curve" title="曲线">
            <img src="img/line.png"     data-type="line"  title="线段">
            <img src="img/polyline.png" data-type="polyline" title="折线">
            <img src="img/rect.png"     data-type="rect"     title="矩形">
            <img src="img/circle.png"   data-type="circle"   title="圆">
            <img src="img/ellipse.png"  data-type="ellipse"  title="椭圆">
            <img src="img/eraser.png"   data-type="eraser"   title="橡皮擦">

            <img src="img/clear.png" data-type="clear" title="清空画布">
            <img src="img/undo.png"  data-type="undo" title="后退一步">
            <img src="img/redo.png"  data-type="redo" title="撤销后退">
        </div>

        <!-- 画布 -->
        <canvas class="canvas" width="400" height="400"></canvas>

        <!-- 右键菜单 -->
        <ul class="menu">
            <li class="menu-item remove">删除</li>
            <li class="menu-item back-one">后移一层</li>
            <li class="menu-item front-one">前移一层</li>
            <li class="menu-item back-most">移到最后面</li>
            <li class="menu-item front-most">移到最前面</li>
        </ul>
    </div>

    <script type="text/javascript">
        // 3. 初始化画图板
        var painter = new Painter($('#painter')); // 创建画图板的对象
        $('#painter .toolbar img:eq(1)').click(); // 默认进行绘制曲线
        var store = []; // 存储 painter 里面的 shapes，key 为 questionId，value 为 shapes

        $('.question-button').click(function(event) {
            var questionId = $(this).attr('data-question-id');
            var shapes = getShapes(questionId);

            layer.open({
                type: 1,
                title: false,
                shade: 0.8,
                closeBtn: 0,
                area: ['450px'], //宽高
                content: $('#painter'),
                btn: ['保存', '取消'],
                success: function() {
                    $('#painter .toolbar img:eq(1)').click();
                    painter.setShapes(shapes); // 更新显示
                },
                yes: function() { // 点击保存执行的回调函数
                    saveShapes(questionId, painter.shapes); // 保存数据，以便可以编辑
                    var base64Image = painter.getImageDataUrl();
                    console.log(base64Image); // 把此 base64Image 传给服务器端，服务器端保存后返回图片的 URL

                    layer.closeAll(); // 关闭弹出窗口
                }
            });
        });

        function getShapes(questionId) {
            return store[questionId] ? store[questionId] : [];
        }

        function saveShapes(questionId, shapes) {
            store[questionId] = shapes;
        }
    </script>
</body>

</html>
